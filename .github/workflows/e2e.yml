name: E2E Tests

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: false
        default: 'docker'
        type: choice
        options:
          - docker
          - staging
  
  # Optional: Trigger on release tags
  # push:
  #   tags:
  #     - 'v*'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-e2e-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-e2e-
            ${{ runner.os }}-buildx-

      - name: Build E2E Stack
        run: |
          docker buildx bake -f docker-compose.test.yml \
            backend frontend \
            --set "*.cache-from=type=local,src=/tmp/.buildx-cache" \
            --set "*.cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max" \
            --load

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Run E2E Tests
        env:
          USE_LOCAL_MODEL: true
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          CHAT_HISTORY_RETENTION_HOURS: 24
        run: |
          # Start backend and frontend services with e2e profile
          docker compose -f docker-compose.test.yml --profile e2e up -d backend frontend
          
          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          timeout 60 bash -c 'until docker compose -f docker-compose.test.yml exec backend curl -f http://localhost:8000/health > /dev/null 2>&1; do sleep 2; done'
          timeout 60 bash -c 'until docker compose -f docker-compose.test.yml exec frontend curl -f http://localhost:80 > /dev/null 2>&1; do sleep 2; done'
          
          # Run E2E tests with e2e profile
          docker compose -f docker-compose.test.yml --profile e2e run --rm e2e-runner

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.test.yml logs backend
          echo "=== Frontend Logs ==="
          docker compose -f docker-compose.test.yml logs frontend
          echo "=== E2E Runner Logs ==="
          docker compose -f docker-compose.test.yml logs e2e-runner

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v
